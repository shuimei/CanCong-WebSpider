<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾è¡¨è°ƒè¯•é¡µé¢</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å›¾è¡¨è°ƒè¯•é¡µé¢</h1>
        
        <div class="debug-info">
            <h3>è°ƒè¯•ä¿¡æ¯</h3>
            <p>Chart.jsç‰ˆæœ¬: <span id="chartVersion">æ£€æŸ¥ä¸­...</span></p>
            <p>Canvasæ”¯æŒ: <span id="canvasSupport">æ£€æŸ¥ä¸­...</span></p>
            <p>æ•°æ®çŠ¶æ€: <span id="dataStatus">æ£€æŸ¥ä¸­...</span></p>
            <p>å›¾è¡¨çŠ¶æ€: <span id="chartStatus">æ£€æŸ¥ä¸­...</span></p>
        </div>
        
        <div>
            <button onclick="testBasicChart()">æµ‹è¯•åŸºæœ¬å›¾è¡¨</button>
            <button onclick="testWithData()">æµ‹è¯•å®é™…æ•°æ®</button>
            <button onclick="loadRealData()">åŠ è½½çœŸå®æ•°æ®</button>
            <button onclick="clearChart()">æ¸…é™¤å›¾è¡¨</button>
        </div>
        
        <div class="chart-container">
            <canvas id="debugChart"></canvas>
        </div>
        
        <div class="debug-info">
            <h3>æ§åˆ¶å°æ—¥å¿—</h3>
            <div id="console" style="height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace;"></div>
        </div>
    </div>

    <script>
        let chart = null;
        
        // é‡å†™console.logä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalError = console.error;
        
        function logToPage(message, type = 'log') {
            const consoleDiv = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : '#0f0';
            consoleDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(message) {
            originalLog(message);
            logToPage(message);
        };
        
        console.error = function(message) {
            originalError(message);
            logToPage(message, 'error');
        };
        
        // åˆå§‹åŒ–æ£€æŸ¥
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥Chart.js
            document.getElementById('chartVersion').textContent = typeof Chart !== 'undefined' ? Chart.version : 'æœªåŠ è½½';
            
            // æ£€æŸ¥Canvasæ”¯æŒ
            const canvas = document.createElement('canvas');
            document.getElementById('canvasSupport').textContent = canvas.getContext ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            
            console.log('Chart.jså¯ç”¨:', typeof Chart !== 'undefined');
            console.log('Canvaså¯ç”¨:', !!canvas.getContext);
        });
        
        function testBasicChart() {
            console.log('å¼€å§‹æµ‹è¯•åŸºæœ¬å›¾è¡¨...');
            
            try {
                clearChart();
                
                const ctx = document.getElementById('debugChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['çº¢è‰²', 'è“è‰²', 'ç»¿è‰²', 'é»„è‰²'],
                        datasets: [{
                            data: [10, 20, 30, 40],
                            backgroundColor: [
                                '#ff6384',
                                '#36a2eb',
                                '#4bc0c0',
                                '#ffce56'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                console.log('âœ… åŸºæœ¬å›¾è¡¨åˆ›å»ºæˆåŠŸ');
                document.getElementById('chartStatus').textContent = 'âœ… åŸºæœ¬å›¾è¡¨æ­£å¸¸';
                
            } catch (error) {
                console.error('âŒ åŸºæœ¬å›¾è¡¨åˆ›å»ºå¤±è´¥: ' + error.message);
                document.getElementById('chartStatus').textContent = 'âŒ åˆ›å»ºå¤±è´¥';
            }
        }
        
        function testWithData() {
            console.log('å¼€å§‹æµ‹è¯•çˆ¬è™«æ•°æ®æ ¼å¼å›¾è¡¨...');
            
            try {
                clearChart();
                
                const stats = {
                    success: 595,
                    pending: 1155,
                    failed: 34,
                    crawling: 67
                };
                
                const ctx = document.getElementById('debugChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['æˆåŠŸ', 'å¾…æŠ“å–', 'å¤±è´¥', 'æŠ“å–ä¸­'],
                        datasets: [{
                            data: [
                                stats.success,
                                stats.pending,
                                stats.failed,
                                stats.crawling
                            ],
                            backgroundColor: [
                                '#28a745',
                                '#ffc107',
                                '#dc3545',
                                '#007bff'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                console.log('âœ… çˆ¬è™«æ•°æ®å›¾è¡¨åˆ›å»ºæˆåŠŸ');
                console.log('æ•°æ®:', [stats.success, stats.pending, stats.failed, stats.crawling]);
                document.getElementById('chartStatus').textContent = 'âœ… çˆ¬è™«å›¾è¡¨æ­£å¸¸';
                document.getElementById('dataStatus').textContent = `âœ… æ•°æ®æ­£å¸¸ (${stats.success + stats.pending + stats.failed + stats.crawling}æ¡)`;
                
            } catch (error) {
                console.error('âŒ çˆ¬è™«å›¾è¡¨åˆ›å»ºå¤±è´¥: ' + error.message);
                document.getElementById('chartStatus').textContent = 'âŒ åˆ›å»ºå¤±è´¥';
            }
        }
        
        async function loadRealData() {
            console.log('å¼€å§‹åŠ è½½çœŸå®APIæ•°æ®...');
            
            try {
                const response = await fetch('http://localhost:8000/api/stats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const stats = await response.json();
                console.log('âœ… APIæ•°æ®åŠ è½½æˆåŠŸ:', stats);
                
                clearChart();
                
                const ctx = document.getElementById('debugChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['æˆåŠŸ', 'å¾…æŠ“å–', 'å¤±è´¥', 'æŠ“å–ä¸­'],
                        datasets: [{
                            data: [
                                stats.success || 0,
                                stats.pending || 0,
                                stats.failed || 0,
                                stats.crawling || 0
                            ],
                            backgroundColor: [
                                '#28a745',
                                '#ffc107',
                                '#dc3545',
                                '#007bff'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                console.log('âœ… çœŸå®æ•°æ®å›¾è¡¨åˆ›å»ºæˆåŠŸ');
                document.getElementById('chartStatus').textContent = 'âœ… çœŸå®æ•°æ®å›¾è¡¨æ­£å¸¸';
                document.getElementById('dataStatus').textContent = `âœ… çœŸå®æ•°æ®: æ€»æ•°${stats.total}`;
                
            } catch (error) {
                console.error('âŒ çœŸå®æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                document.getElementById('dataStatus').textContent = 'âŒ APIè¿æ¥å¤±è´¥';
            }
        }
        
        function clearChart() {
            if (chart) {
                chart.destroy();
                chart = null;
                console.log('å›¾è¡¨å·²æ¸…é™¤');
            }
        }
    </script>
</body>
</html>