<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页爬虫监控台</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-success { background-color: #28a745; }
        .status-pending { background-color: #ffc107; }
        .status-failed { background-color: #dc3545; }
        .status-crawling { background-color: #007bff; }
        
        .page-item {
            transition: background-color 0.2s;
        }
        .page-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-box {
            max-width: 400px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="bi bi-spider"></i> 网页爬虫监控台
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" href="/">
                        <i class="bi bi-house"></i> 监控台
                    </a>
                    <a class="nav-link" href="/crawler">
                        <i class="bi bi-gear"></i> 抓取配置
                    </a>
                    <span class="navbar-text">
                        <i class="bi bi-clock"></i> {{ currentTime }}
                    </span>
                </div>
            </div>
        </nav>

        <!-- 连接状态指示器 -->
        <div class="connection-status">
            <span v-if="wsConnected" class="badge bg-success">
                <i class="bi bi-wifi"></i> 已连接
            </span>
            <span v-else class="badge bg-danger">
                <i class="bi bi-wifi-off"></i> 连接断开
            </span>
        </div>

        <!-- 主要内容 -->
        <div class="container mt-4">
            <!-- 统计卡片 -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card border-primary">
                        <div class="card-body text-center">
                            <i class="bi bi-collection text-primary fs-1"></i>
                            <h4 class="card-title text-primary">{{ stats.total }}</h4>
                            <p class="card-text">总URL数</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card border-success">
                        <div class="card-body text-center">
                            <i class="bi bi-check-circle text-success fs-1"></i>
                            <h4 class="card-title text-success">{{ stats.success }}</h4>
                            <p class="card-text">抓取成功</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card border-warning">
                        <div class="card-body text-center">
                            <i class="bi bi-hourglass-split text-warning fs-1"></i>
                            <h4 class="card-title text-warning">{{ stats.pending }}</h4>
                            <p class="card-text">待抓取</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card border-danger">
                        <div class="card-body text-center">
                            <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                            <h4 class="card-title text-danger">{{ stats.failed }}</h4>
                            <p class="card-text">抓取失败</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图表和控制面板 -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-bar-chart"></i> 抓取状态分布</h5>
                            <button class="btn btn-sm btn-outline-secondary" @click="refreshChart" title="刷新图表">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statsChart"></canvas>
                            </div>
                            <!-- 调试信息 -->
                            <div class="mt-2 small text-muted" v-if="stats.total > 0">
                                数据: 成功({{ stats.success }}) 待抓取({{ stats.pending }}) 失败({{ stats.failed }}) 抓取中({{ stats.crawling }})
                            </div>
                            <div class="mt-1 small text-danger" v-else>
                                暂无数据或数据加载中...
                            </div>
                            <!-- 图表状态调试 -->
                            <div class="mt-1 small" :class="chart ? 'text-success' : 'text-warning'">
                                图表状态: {{ chart ? '✓ 已初始化' : '⚠ 未初始化' }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-search"></i> 搜索网页</h5>
                        </div>
                        <div class="card-body">
                            <div class="input-group mb-3">
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    placeholder="搜索URL或标题..." 
                                    v-model="searchKeyword"
                                    @keyup.enter="searchPages"
                                >
                                <button class="btn btn-outline-primary" @click="searchPages">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-info" @click="refreshData">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新数据
                                </button>
                                <button class="btn btn-secondary" @click="showFailedPages">
                                    <i class="bi bi-exclamation-circle"></i> 查看失败页面
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 页面列表 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-file-earmark-text"></i> {{ getViewTitle() }}</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" @click="showRecentPages">最近页面</button>
                        <button class="btn btn-sm btn-outline-info" @click="showAllFiles">所有文件</button>
                        <span class="badge bg-secondary ms-2">{{ pages.length }} 个结果</span>
                    </div>
                </div>
                <div class="card-body">
                    <div v-if="loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                    
                    <div v-else-if="pages.length === 0" class="text-center text-muted">
                        <i class="bi bi-inbox fs-1"></i>
                        <p>暂无数据</p>
                    </div>
                    
                    <div v-else class="list-group">
                        <div 
                            v-for="(page, index) in pages" 
                            :key="index" 
                            class="list-group-item list-group-item-action page-item"
                        >
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="status-indicator" :class="getStatusClass(page.status)"></span>
                                        <h6 class="mb-0">{{ page.title }}</h6>
                                    </div>
                                    <p class="mb-1 text-muted small">{{ page.url }}</p>
                                    <div v-if="page.crawled_time" class="text-muted small">
                                        <i class="bi bi-clock"></i> {{ formatTime(page.crawled_time) }}
                                    </div>
                                    <div v-if="page.error" class="text-danger small mt-1">
                                        <i class="bi bi-exclamation-triangle"></i> {{ page.error }}
                                    </div>
                                </div>
                                <div class="btn-group-vertical" v-if="page.html_file && page.file_exists">
                                    <button 
                                        class="btn btn-sm btn-outline-primary"
                                        @click="viewPage(page.html_file)"
                                        title="在线查看"
                                    >
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button 
                                        class="btn btn-sm btn-outline-secondary"
                                        @click="downloadPage(page.html_file)"
                                        title="下载文件"
                                    >
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面查看模态框 -->
        <div class="modal fade" id="pageViewModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">页面预览</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <iframe 
                            :src="viewingPageUrl" 
                            style="width: 100%; height: 600px; border: none;"
                            v-if="viewingPageUrl"
                        ></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- 刷新按钮 -->
        <button class="btn btn-primary refresh-btn" @click="refreshData" title="刷新数据">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    stats: {
                        total: 0,
                        pending: 0,
                        success: 0,
                        failed: 0,
                        crawling: 0,
                        update_time: ''
                    },
                    pages: [],
                    failedPages: [],
                    searchKeyword: '',
                    currentView: 'recent', // 'recent', 'search', 'failed'
                    loading: false,
                    wsConnected: false,
                    websocket: null,
                    currentTime: '',
                    viewingPageUrl: '',
                    chart: null
                }
            },
            mounted() {
                console.log('Vue组件已挂载');
                this.initWebSocket();
                this.updateTime();
                
                // 确保 DOM 元素存在后再初始化图表
                this.$nextTick(() => {
                    console.log('DOM更新完成，开始初始化图表');
                    // 稍微延迟确保元素完全渲染
                    setTimeout(() => {
                        this.initChart();
                    }, 100);
                    
                    // 如果WebSocket连接不成功，则主动加载数据
                    setTimeout(() => {
                        if (!this.wsConnected) {
                            console.log('WebSocket未连接，使用HTTP加载数据');
                            this.loadStats().then(() => {
                                this.loadPages();
                            });
                        }
                    }, 2000);
                });
                
                setInterval(this.updateTime, 1000);
            },
            methods: {
                initWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        this.wsConnected = true;
                        console.log('WebSocket连接已建立');
                        // 连接成功后主动请求数据
                        setTimeout(() => {
                            this.websocket.send(JSON.stringify({ type: 'request_update' }));
                        }, 500);
                    };
                    
                    this.websocket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    };
                    
                    this.websocket.onclose = () => {
                        this.wsConnected = false;
                        console.log('WebSocket连接已断开');
                        // 5秒后重连
                        setTimeout(this.initWebSocket, 5000);
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('WebSocket错误:', error);
                    };
                },
                
                handleWebSocketMessage(message) {
                    console.log('WebSocket消息:', message);
                    switch (message.type) {
                        case 'initial_data':
                            console.log('收到初始数据');
                            this.stats = message.data.stats;
                            this.pages = message.data.pages;
                            this.updateChart();
                            break;
                        case 'stats_update':
                            console.log('收到统计更新');
                            this.stats = message.data;
                            this.updateChart();
                            break;
                        case 'data_update':
                            console.log('收到数据更新');
                            this.stats = message.data.stats;
                            if (this.currentView === 'recent') {
                                this.pages = message.data.pages;
                            }
                            this.updateChart();
                            break;
                    }
                },
                
                async refreshData() {
                    if (this.websocket && this.wsConnected) {
                        this.websocket.send(JSON.stringify({ type: 'request_update' }));
                    } else {
                        // 备用HTTP请求
                        await this.loadStats();
                        await this.loadPages();
                    }
                },
                
                async loadStats() {
                    try {
                        console.log('加载统计数据...');
                        const response = await fetch('/api/stats');
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const newStats = await response.json();
                        console.log('获取到统计数据:', newStats);
                        
                        this.stats = newStats;
                        
                        // 确保图表存在后更新
                        if (this.chart) {
                            this.updateChart();
                        } else {
                            console.log('图表不存在，尝试初始化');
                            this.initChart();
                        }
                    } catch (error) {
                        console.error('加载统计数据失败:', error);
                    }
                },
                
                async loadPages() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/pages');
                        this.pages = await response.json();
                        this.currentView = 'recent';
                    } catch (error) {
                        console.error('加载页面列表失败:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async searchPages() {
                    if (!this.searchKeyword.trim()) {
                        this.showRecentPages();
                        return;
                    }
                    
                    this.loading = true;
                    try {
                        const response = await fetch(`/api/search?q=${encodeURIComponent(this.searchKeyword)}`);
                        this.pages = await response.json();
                        this.currentView = 'search';
                    } catch (error) {
                        console.error('搜索失败:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async showFailedPages() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/failed');
                        const failedData = await response.json();
                        // 转换为页面格式
                        this.pages = failedData.map(item => ({
                            url: item.url,
                            title: '失败页面',
                            error: item.error,
                            crawled_time: item.time,
                            status: 'failed',
                            file_exists: false
                        }));
                        this.currentView = 'failed';
                    } catch (error) {
                        console.error('加载失败页面失败:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                showRecentPages() {
                    this.searchKeyword = '';
                    this.loadPages();
                },
                
                async showAllFiles() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/files');
                        this.pages = await response.json();
                        this.currentView = 'files';
                    } catch (error) {
                        console.error('加载文件列表失败:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                viewPage(filename) {
                    this.viewingPageUrl = `/api/view/${filename}`;
                    const modal = new bootstrap.Modal(document.getElementById('pageViewModal'));
                    modal.show();
                },
                
                downloadPage(filename) {
                    window.open(`/api/download/${filename}`, '_blank');
                },
                
                getStatusClass(status) {
                    const statusMap = {
                        'success': 'status-success',
                        'pending': 'status-pending',
                        'failed': 'status-failed',
                        'crawling': 'status-crawling'
                    };
                    return statusMap[status] || 'status-pending';
                },
                
                formatTime(timeStr) {
                    if (!timeStr) return '未知时间';
                    try {
                        return new Date(timeStr).toLocaleString('zh-CN');
                    } catch {
                        return timeStr;
                    }
                },
                
                getViewTitle() {
                    const titles = {
                        'recent': '最近抓取的页面',
                        'search': '搜索结果',
                        'failed': '失败的页面',
                        'files': '所有文件'
                    };
                    return titles[this.currentView] || '页面列表';
                },
                
                updateTime() {
                    this.currentTime = new Date().toLocaleString('zh-CN');
                },
                
                refreshChart() {
                    console.log('手动刷新图表');
                    this.loadStats();
                },
                
                initChart() {
                    try {
                        const canvas = document.getElementById('statsChart');
                        if (!canvas) {
                            console.error('找不到图表元素');
                            setTimeout(() => this.initChart(), 1000); // 1秒后重试
                            return;
                        }
                        
                        const ctx = canvas.getContext('2d');
                        if (!ctx) {
                            console.error('无法获取图表上下文');
                            return;
                        }
                        
                        // 如果已存在图表，先销毁
                        if (this.chart) {
                            this.chart.destroy();
                            console.log('销毁旧图表');
                        }
                        
                        console.log('初始化图表...');
                        console.log('Chart.js版本:', Chart.version);
                        
                        this.chart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['成功', '待抓取', '失败', '抓取中'],
                                datasets: [{
                                    data: [0, 0, 0, 0],
                                    backgroundColor: [
                                        '#28a745',
                                        '#ffc107',
                                        '#dc3545',
                                        '#007bff'
                                    ],
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: {
                                    duration: 1000
                                },
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 20,
                                            usePointStyle: true
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                                return `${label}: ${value} (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        console.log('图表初始化成功', this.chart);
                        
                        // 立即更新数据
                        this.updateChart();
                    } catch (error) {
                        console.error('图表初始化失败:', error);
                        // 3秒后重试
                        setTimeout(() => this.initChart(), 3000);
                    }
                },
                
                updateChart() {
                    if (!this.chart) {
                        console.warn('图表未初始化，尝试重新初始化');
                        this.initChart();
                        return;
                    }
                    
                    try {
                        console.log('更新图表数据:', this.stats);
                        const data = [
                            this.stats.success || 0,
                            this.stats.pending || 0,
                            this.stats.failed || 0,
                            this.stats.crawling || 0
                        ];
                        console.log('图表数据数组:', data);
                        console.log('数据总和:', data.reduce((a, b) => a + b, 0));
                        
                        this.chart.data.datasets[0].data = data;
                        this.chart.update('active');
                        console.log('图表更新成功');
                    } catch (error) {
                        console.error('图表更新失败:', error);
                        // 尝试重新初始化
                        setTimeout(() => {
                            this.initChart();
                        }, 1000);
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>